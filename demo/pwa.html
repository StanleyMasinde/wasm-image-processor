<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>PWA Icon Generator</title>
	<style>
		body {
			font-family: Arial, sans-serif;
			max-width: 1200px;
			margin: 0 auto;
			padding: 20px;
		}
		.upload-section {
			border: 2px dashed #ccc;
			border-radius: 8px;
			padding: 40px;
			text-align: center;
			margin: 20px 0;
			background-color: #f9f9f9;
		}
		.upload-section.dragover {
			border-color: #007bff;
			background-color: #e3f2fd;
		}
		.file-input {
			display: none;
		}
		.upload-btn {
			background-color: #007bff;
			color: white;
			padding: 12px 24px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
		}
		.upload-btn:hover {
			background-color: #0056b3;
		}
		.controls {
			margin: 20px 0;
			text-align: center;
		}
		.generate-btn {
			background-color: #28a745;
			color: white;
			padding: 15px 30px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 18px;
			font-weight: bold;
		}
		.generate-btn:hover {
			background-color: #218838;
		}
		.generate-btn:disabled {
			background-color: #6c757d;
			cursor: not-allowed;
		}
		.download-all-btn {
			background-color: #6f42c1;
			color: white;
			padding: 12px 24px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 16px;
			margin: 20px 10px;
		}
		.download-all-btn:hover {
			background-color: #5a32a3;
		}
		.download-all-btn:disabled {
			background-color: #6c757d;
			cursor: not-allowed;
		}
		.icons-grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
			gap: 20px;
			margin: 20px 0;
		}
		.icon-box {
			border: 1px solid #ddd;
			border-radius: 8px;
			padding: 15px;
			text-align: center;
			background-color: #f8f9fa;
		}
		.icon-box h4 {
			margin-top: 0;
			color: #333;
		}
		.icon-box img {
			border: 1px solid #ddd;
			border-radius: 4px;
		}
		.icon-info {
			margin-top: 10px;
			font-size: 14px;
			color: #666;
		}
		.download-link {
			display: inline-block;
			margin-top: 10px;
			padding: 8px 16px;
			background-color: #17a2b8;
			color: white;
			text-decoration: none;
			border-radius: 4px;
			font-size: 12px;
		}
		.download-link:hover {
			background-color: #138496;
		}
		.error {
			color: #dc3545;
			background-color: #f8d7da;
			border: 1px solid #f5c6cb;
			padding: 10px;
			border-radius: 4px;
			margin: 10px 0;
		}
		.loading {
			color: #007bff;
			font-style: italic;
			font-size: 16px;
		}
		.manifest-section {
			margin: 30px 0;
			padding: 20px;
			background-color: #f8f9fa;
			border-radius: 8px;
			border: 1px solid #ddd;
		}
		.manifest-section h3 {
			margin-top: 0;
		}
		.manifest-code {
			background-color: #fff;
			border: 1px solid #ddd;
			border-radius: 4px;
			padding: 15px;
			font-family: 'Courier New', monospace;
			font-size: 12px;
			white-space: pre-wrap;
			overflow-x: auto;
		}
		.copy-btn {
			background-color: #6c757d;
			color: white;
			padding: 5px 10px;
			border: none;
			border-radius: 4px;
			cursor: pointer;
			font-size: 12px;
			margin-top: 10px;
		}
		.copy-btn:hover {
			background-color: #545b62;
		}
	</style>
</head>
<body>
	<main>
		<h1>PWA Icon Generator</h1>
		<p>Upload one square image and generate all the icons needed for your Progressive Web App!</p>

		<section>
			<div class="upload-section" id="uploadSection">
				<p>Drag and drop a square image here (recommended: 1024x1024 or larger)</p>
				<input type="file" id="fileInput" class="file-input" accept="image/*">
				<button type="button" class="upload-btn" onclick="document.getElementById('fileInput').click()">
					Select Image
				</button>
			</div>

			<div class="controls" id="controls" style="display: none;">
				<button type="button" class="generate-btn" id="generateBtn">Generate All PWA Icons</button>
			</div>

			<div id="error" class="error" style="display: none;"></div>
			<div id="loading" class="loading" style="display: none;">Generating icons...</div>

			<div id="downloadSection" style="display: none; text-align: center;">
				<button type="button" class="download-all-btn" id="downloadAllBtn">Download All Icons (ZIP)</button>
			</div>

			<div class="icons-grid" id="iconsGrid" style="display: none;"></div>

			<div class="manifest-section" id="manifestSection" style="display: none;">
				<h3>Web App Manifest Icons Section</h3>
				<p>Copy this JSON and add it to your <code>manifest.json</code> file:</p>
				<div class="manifest-code" id="manifestCode"></div>
				<button type="button" class="copy-btn" onclick="copyManifest()">Copy to Clipboard</button>
			</div>
		</section>
	</main>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
	<script type="module">
		import init, { resize_image } from "/pwa_image_generator.js";

		const PWA_SIZES = [
			{ size: 16, name: "favicon-16x16.png", purpose: "Favicon" },
			{ size: 32, name: "favicon-32x32.png", purpose: "Favicon" },
			{ size: 48, name: "icon-48x48.png", purpose: "PWA Icon" },
			{ size: 72, name: "icon-72x72.png", purpose: "PWA Icon" },
			{ size: 96, name: "icon-96x96.png", purpose: "PWA Icon" },
			{ size: 128, name: "icon-128x128.png", purpose: "PWA Icon" },
			{ size: 144, name: "icon-144x144.png", purpose: "PWA Icon" },
			{ size: 152, name: "icon-152x152.png", purpose: "PWA Icon" },
			{ size: 180, name: "icon-180x180.png", purpose: "Apple Touch Icon" },
			{ size: 192, name: "icon-192x192.png", purpose: "PWA Icon" },
			{ size: 256, name: "icon-256x256.png", purpose: "PWA Icon" },
			{ size: 384, name: "icon-384x384.png", purpose: "PWA Icon" },
			{ size: 512, name: "icon-512x512.png", purpose: "PWA Icon" }
		];

		let wasmModule = null;
		let selectedImageData = null;
		let generatedIcons = [];

		init().then((wasm) => {
			wasmModule = wasm;
			console.log("WASM module loaded successfully");
		}).catch(error => {
			showError("Failed to load WASM module: " + error.message);
		});

		const fileInput = document.getElementById('fileInput');
		const uploadSection = document.getElementById('uploadSection');
		const controls = document.getElementById('controls');
		const generateBtn = document.getElementById('generateBtn');
		const iconsGrid = document.getElementById('iconsGrid');
		const downloadAllBtn = document.getElementById('downloadAllBtn');

		fileInput.addEventListener('change', handleFileSelect);
		generateBtn.addEventListener('click', generateAllIcons);
		downloadAllBtn.addEventListener('click', downloadAllIcons);

		uploadSection.addEventListener('dragover', (e) => {
			e.preventDefault();
			uploadSection.classList.add('dragover');
		});

		uploadSection.addEventListener('dragleave', () => {
			uploadSection.classList.remove('dragover');
		});

		uploadSection.addEventListener('drop', (e) => {
			e.preventDefault();
			uploadSection.classList.remove('dragover');

			const files = e.dataTransfer.files;
			if (files.length > 0) {
				handleFile(files[0]);
			}
		});

		function handleFileSelect(event) {
			const file = event.target.files[0];
			if (file) {
				handleFile(file);
			}
		}

		function handleFile(file) {
			if (!file.type.startsWith('image/')) {
				showError('Please select a valid image file.');
				return;
			}

			const img = new Image();
			img.onload = () => {
				const ratio = img.width / img.height;
				if (ratio < 0.8 || ratio > 1.2) {
					showError('Warning: Image is not square. PWA icons work best with square images.');
				}
			};
			img.src = URL.createObjectURL(file);

			const reader = new FileReader();
			reader.onload = (e) => {
				selectedImageData = new Uint8Array(e.target.result);
				controls.style.display = 'block';
				hideError();
			};
			reader.onerror = () => {
				showError('Error reading file.');
			};
			reader.readAsArrayBuffer(file);
		}

		async function generateAllIcons() {
			if (!wasmModule || !selectedImageData) {
				showError('WASM module not loaded or no image selected.');
				return;
			}

			showLoading(true);
			generateBtn.disabled = true;
			generatedIcons = [];
			iconsGrid.innerHTML = '';

			try {
				for (const iconSpec of PWA_SIZES) {
					const resizedBytes = resize_image(Array.from(selectedImageData), iconSpec.size);
					const blob = new Blob([new Uint8Array(resizedBytes)], { type: 'image/png' });
					const url = URL.createObjectURL(blob);

					generatedIcons.push({
						...iconSpec,
						blob,
						url,
						bytes: resizedBytes
					});

					const iconBox = document.createElement('div');
					iconBox.className = 'icon-box';
					iconBox.innerHTML = `
						<h4>${iconSpec.name}</h4>
						<img src="${url}" alt="${iconSpec.name}" style="width: ${Math.min(iconSpec.size, 128)}px; height: ${Math.min(iconSpec.size, 128)}px;">
						<div class="icon-info">
							${iconSpec.size}x${iconSpec.size} pixels<br>
							${iconSpec.purpose}<br>
							${(blob.size / 1024).toFixed(1)} KB
						</div>
						<a href="${url}" download="${iconSpec.name}" class="download-link">Download</a>
					`;
					iconsGrid.appendChild(iconBox);
				}

				iconsGrid.style.display = 'grid';
				document.getElementById('downloadSection').style.display = 'block';
				generateManifest();
				showLoading(false);
				generateBtn.disabled = false;
				hideError();

			} catch (error) {
				showError('Error generating icons: ' + error.message);
				showLoading(false);
				generateBtn.disabled = false;
			}
		}

		async function downloadAllIcons() {
			if (generatedIcons.length === 0) {
				showError('No icons generated yet.');
				return;
			}

			try {
				const zip = new JSZip();

				for (const icon of generatedIcons) {
					const arrayBuffer = await icon.blob.arrayBuffer();
					zip.file(icon.name, arrayBuffer);
				}

				const manifestContent = generateManifestJSON();
				zip.file("manifest-icons.json", manifestContent);

				const zipBlob = await zip.generateAsync({type: "blob"});
				const zipUrl = URL.createObjectURL(zipBlob);

				const a = document.createElement('a');
				a.href = zipUrl;
				a.download = 'pwa-icons.zip';
				document.body.appendChild(a);
				a.click();
				document.body.removeChild(a);

				URL.revokeObjectURL(zipUrl);

			} catch (error) {
				showError('Error creating ZIP file: ' + error.message);
			}
		}

		function generateManifest() {
			const manifestCode = document.getElementById('manifestCode');
			const manifestSection = document.getElementById('manifestSection');

			manifestCode.textContent = generateManifestJSON();
			manifestSection.style.display = 'block';
		}

		function generateManifestJSON() {
			const icons = generatedIcons.map(icon => ({
				src: icon.name,
				sizes: `${icon.size}x${icon.size}`,
				type: "image/png"
			}));

			return JSON.stringify(icons, null, 2);
		}

		function copyManifest() {
			const manifestCode = document.getElementById('manifestCode');
			navigator.clipboard.writeText(manifestCode.textContent).then(() => {
				const copyBtn = document.querySelector('.copy-btn');
				const originalText = copyBtn.textContent;
				copyBtn.textContent = 'Copied!';
				setTimeout(() => {
					copyBtn.textContent = originalText;
				}, 2000);
			}).catch(() => {
				showError('Failed to copy to clipboard.');
			});
		}

		function showError(message) {
			const errorDiv = document.getElementById('error');
			errorDiv.textContent = message;
			errorDiv.style.display = 'block';
		}

		function hideError() {
			document.getElementById('error').style.display = 'none';
		}

		function showLoading(show) {
			document.getElementById('loading').style.display = show ? 'block' : 'none';
		}

		window.copyManifest = copyManifest;
	</script>
</body>
</html>
